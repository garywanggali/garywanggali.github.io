<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>World Map with State Flags</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        #map {
            height: 500px;
            width: 100%;
        }
        /* 这里给图标容器加基础样式 */
        .flag-marker img {
            display: block;
            pointer-events: none; /* 图标不阻止地图拖拽 */
        }
    </style>
</head>
<body>
    <h1>World Map with State Flags</h1>
    <div id="map"></div>

    <script src="https://cdn.jsdelivr.net/npm/leaflet@1.7.1/dist/leaflet.js"></script>
    <script>
        // 你手写的特殊州中心点（阿拉斯加举例）
        const manualCenters = {
            'Alaska': [61.2181, -149.9003], // 注意：纬度, 经度
            'Hawaii': [20.7967, -156.3319]
        };

        const stateFlags = {
            'Alabama': 'alabama_flag.png',
            'Alaska': 'alaska_flag.png',
            'Arizona': 'arizona_flag.png',
            'Arkansas': 'arkansas_flag.png',
            'California': 'california_flag.png',
            'Colorado': 'colorado_flag.png',
            'Connecticut': 'connecticut_flag.png',
            'Delaware': 'delaware_flag.png',
            'Florida': 'florida_flag.png',
            'Georgia': 'georgia_flag.png',
            'Hawaii': 'hawaii_flag.png',
            'Idaho': 'idaho_flag.png',
            'Illinois': 'illinois_flag.png',
            'Indiana': 'indiana_flag.png',
            'Iowa': 'iowa_flag.png',
            'Kansas': 'kansas_flag.png',
            'Kentucky': 'kentucky_flag.png',
            'Louisiana': 'louisiana_flag.png',
            'Maine': 'maine_flag.png',
            'Maryland': 'maryland_flag.png',
            'Massachusetts': 'massachusetts_flag.png',
            'Michigan': 'michigan_flag.png',
            'Minnesota': 'minnesota_flag.png',
            'Mississippi': 'mississippi_flag.png',
            'Missouri': 'missouri_flag.png',
            'Montana': 'montana_flag.png',
            'Nebraska': 'nebraska_flag.png',
            'Nevada': 'nevada_flag.png',
            'New Hampshire': 'new_hampshire_flag.png',
            'New Jersey': 'new_jersey_flag.png',
            'New Mexico': 'new_mexico_flag.png',
            'New York': 'new_york_flag.png',
            'North Carolina': 'north_carolina_flag.png',
            'North Dakota': 'north_dakota_flag.png',
            'Ohio': 'ohio_flag.png',
            'Oklahoma': 'oklahoma_flag.png',
            'Oregon': 'oregon_flag.png',
            'Pennsylvania': 'pennsylvania_flag.png',
            'Rhode Island': 'rhode_island_flag.png',
            'South Carolina': 'south_carolina_flag.png',
            'South Dakota': 'south_dakota_flag.png',
            'Tennessee': 'tennessee_flag.png',
            'Texas': 'texas_flag.png',
            'Utah': 'utah_flag.png',
            'Vermont': 'vermont_flag.png',
            'Virginia': 'virginia_flag.png',
            'Washington': 'washington_flag.png',
            'West Virginia': 'west_virginia_flag.png',
            'Wisconsin': 'wisconsin_flag.png',
            'Wyoming': 'wyoming_flag.png'
        };

        const map = L.map('map').setView([37, -96], 4);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        // 用于存储所有marker，方便缩放时更新图标大小
        const markers = [];

        // 创建DivIcon函数，size单位是像素
        function createFlagIcon(url, size) {
            return L.divIcon({
                className: 'flag-marker',
                html: `<img src="${url}" style="width:${size}px; height:${size * 0.7}px;">`,
                iconSize: [size, size * 0.7],
                iconAnchor: [size / 2, (size * 0.7) / 2]
            });
        }

        fetch('usa_states.geojson')
        .then(response => response.json())
        .then(data => {
            L.geoJSON(data, {
                onEachFeature: function(feature, layer) {
                    const stateName = feature.properties.NAME_1;
                    const flagFile = stateFlags[stateName];

                    // 优先用手写中心点
                    let center = manualCenters[stateName];
                    if (!center) {
                        center = layer.getBounds().getCenter();
                    }

                    if (flagFile) {
                        const icon = createFlagIcon(flagFile, 40);
                        const marker = L.marker(center, { icon }).addTo(map);
                        markers.push({ marker, flagFile, center });
                    }
                }
            }).addTo(map);

            // 地图缩放时更新所有图标大小
            function updateIconSizes() {
                const zoom = map.getZoom();
                // 你可以调节这里的基准大小和缩放系数
                const baseSize = 6; // 缩放倍数基准
                const size = baseSize * zoom;

                markers.forEach(({ marker, flagFile }) => {
                    const newIcon = createFlagIcon(flagFile, size);
                    marker.setIcon(newIcon);
                });
            }

            map.on('zoomend', updateIconSizes);
            updateIconSizes();  // 初始调用一次
        });
    </script>
</body>
</html>
